<template>
  <Modal v-model="visible" :title="title" @on-cancel="cancel">
    <Form ref="authForm" :model="formParams" :rules="ruleInline">
      <FormItem  :label-width="100" prop="ownerId" label="变更所有者">
        <Select v-model="formParams.ownerId" :label-in-value="true" @on-change="selectUserData" style="width:300px" placeholder="请选择">
          <Option v-for="item in authStrategyData.userList" :value="item.uid" :key="item.uid">{{ item.userName }}</Option>
        </Select>
      </FormItem>
      <FormItem v-if="isStrategyOp" :label-width="100" label="读权限">
        <Table height="300" border ref="selection" :columns="columns" :loading="loading" :data="strategyDataGroup" @on-selection-change="selectRetryHandle"></Table>
      </FormItem>
      <!--<FormItem v-if="isStrategyOp" prop="selectionTableArr" :label-width="100" label="读权限">-->
        <!--<Table height="300" border ref="selection" :columns="columns" :data="strategyDataGroup" @on-selection-change="selectRetryHandle"></Table>-->
      <!--</FormItem>-->
    </Form>
    <template slot="footer">
      <Button type="primary" :loading="save_loading" @click="ok">保存</Button>
      <Button type="text" @click="cancel">取消</Button>
    </template>
  </Modal>
</template>

<script>
import Cookies from 'js-cookie';
import Qs from 'qs';
import { mapGetters } from 'vuex';
export default {
  name: 'Authorization',
  props: {
    value: { type: Boolean, default: false },
    title: { type: String, default: '授权范围' },
    submitUrl: { type: String, default: '' }
  },
  data () {
    return {
      loading: false,
      isStrategyOp: false,
      isHas: true,
      save_loading: false,
      visible: this.value,
      formParams: { id: '', ownerId: '', selectionTableArr: [] },
      strategyParams: {
        group: '', // 策略分组 贷前loanBefore，loanBeforeRisk，贷中 loan，loanRisk，信息验证verify，verifyRisk
        ownerId: '', // ID
        ownerName: '', // 名称
        strategyGroups: [], // 策略分组
        strategyId: 1, // 策略ID
        strategyCode: '', // 策略Code
        strategyName: '' // 策略名称
      },
      ruleInline: {
        ownerId: [{ required: true, message: '该项为必选项！' }]
        // selectionTableArr: [{ required: true, type: 'array', min: 1, message: '请至少选择一项', trigger: 'change' }]
      },
      authStrategyCfg: {
        group: 'loanRisk',
        strategyCode: 'STRB0000053',
        strategyId: '217',
        strategyName: '测试数据01'
      },
      authStrategyCfg193: {
        group: 'loanRisk',
        strategyCode: 'STRB0000002',
        strategyId: '41',
        strategyName: '新建策略二'
      },
      authStrategyData: {
        userList: []
      },
      options: {
        method: 'GET',
        headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
        credentials: 'same-origin', // 'same-origin', include
        mode: 'cors',
        cache: 'force-cache'
      },
      columns: [
        {
          title: '权限组名称',
          renderHeader: (h, params) => {
            return h('label', params.column.title);
          },
          // render: (h, params) => {
          //   return h('div', [
          //     h('Checkbox', {
          //       props: {
          //         label: params.row.name,
          //         size: 'small'
          //       },
          //       style: {
          //         marginRight: '5px'
          //       },
          //       on: {
          //         click: () => {
          //           this.show(params.index)
          //         }
          //       }
          //     }, params.row.name)
          //   ]);
          // },
          key: 'name'
        },
        {
          // type: 'selection',
          title: '读权限',
          renderHeader: (h, params) => {
            // console.log(h, params);
            return h('label', params.column.title);
          },
          align: 'center',
          children: [
            {
              title: '读权限',
              type: 'selection',
              key: 'rangeType',
              // className: 'def-show-column',
              align: 'center'
              // },
              // {
              //   title: 'Company Name',
              //   key: 'cname',
              //   align: 'center',
              //   width: 100
            }
          ]
        }
      ],
      strategyDataGroup: [],
      strategyDataGroup1: [
        {
          name: '组1',
          rangeType: 2
        },
        {
          name: '组2',
          rangeType: 1
        }
      ]
    };
  },
  computed: {
    ...mapGetters('user/', { authData: 'authData' })
  },
  methods: {
    uniqueArr (array) {
      // 数组去重
      var n = []; // 一个新的临时数组 uid
      var keyObj = {};
      array.forEach((item) => {
        keyObj[item.uid] = item;
      });
      Object.keys(keyObj).forEach(function (key) {
        n.push(keyObj[key]);
      });
      return n;
    },
    initData () {
      const { permissionGroups } = this.authData || {};
      const { adminUser, dataGroupUser } = permissionGroups || {};
      let adminUserArr = adminUser || [];
      let concatNoUniqueArr = adminUserArr.concat(dataGroupUser || []);
      // this.authStrategyData.userList = (permissionGroups && permissionGroups.dataGroupUser) || [];
      this.authStrategyData.userList = this.uniqueArr(concatNoUniqueArr);
      if (this.authStrategyData.userList && !this.authStrategyData.userList.length) {
        this.$Message.error('用户所在组数据为空错误！');
      }
    },
    initStrategy () {
      this.loading = true;
      this.options.method = 'GET';
      let url = '/api/auth-service/resourceStrategy/strategyMessage';
      if (this.options.method === 'GET') {
        url = url + '?' + Qs.stringify(this.getSid()) + '&' + Qs.stringify(this.authStrategyCfg);
        delete this.options.body;
      } else {
        this.options.body = Qs.stringify(this.getSid()) + '&' + Qs.stringify(this.authStrategyCfg);
      }
      fetch(url, this.options)
        .then(response => response.json())
        .then(({ code, data, message }) => {
          this.loading = false;
          if (code === '000000') {
            this.authStrategyData = data;
            if (this.authStrategyData && this.authStrategyData.userList && !this.authStrategyData.userList.length) {
              this.$Message.error('用户所在组数据为空错误！');
            }
            // 0: 读写；1，读；2，写 (默认只有 1：读 的权限)  其他的就是没有勾选的状态
            let singleSelectArr = []; // 选中状态条件
            this.authStrategyData && this.authStrategyData.groups && this.authStrategyData.groups.map((item) => {
              item.isReadSelected = false;
              item.isWriteSelected = false;
              item._checked = false;
              if (item.rangeType === 0 || item.rangeType === 1) {
                item.isReadSelected = true; // 读 选中
                item._checked = true;
                let obj = {
                  id: item.id,
                  name: item.name,
                  rangeType: item.rangeType
                };
                singleSelectArr.push(obj);
              }
            });
            this.formParams.selectionTableArr = singleSelectArr;
            this.strategyParams.strategyGroups = singleSelectArr;
            this.strategyDataGroup = this.authStrategyData.groups || [];
          } else {
            this.$Message.error(message || '服务器错误！');
          }
        }, reason => {
          this.$Message.error(reason || '服务器错误！');
        });
    },
    getSid (sessionId = Cookies.get('BR_COMPASS_SESSIONID')) {
      return { sessionId, t: Date.now() };
    },
    setId ({ id }) {
      this.formParams.id = id;
    },
    selectUserData (selectData) {
      if (selectData && selectData.value) {
        // console.log(200, this.formParams.ownerId, selectData.value);
        this.strategyParams.ownerId = selectData.value;
        this.strategyParams.ownerName = selectData.label;
      }
    },
    selectRetryHandle (selectionArr) {
      let singleSelectArr = [];
      selectionArr.map(sItem => {
        let obj = {
          id: sItem.id,
          name: sItem.name,
          rangeType: sItem.rangeType
        };
        singleSelectArr.push(obj);
      });
      this.formParams.selectionTableArr = selectionArr;
      this.strategyParams.strategyGroups = singleSelectArr;
    },
    resetParams () {
      this.save_loading = false;
    },
    strategySubmit () {
      this.strategyParams.group = this.authStrategyCfg.group;
      this.strategyParams.strategyId = this.authStrategyCfg.strategyId;
      this.strategyParams.strategyCode = this.authStrategyCfg.strategyCode;
      this.strategyParams.strategyName = this.authStrategyCfg.strategyName;
      // this.options.body = Qs.stringify(this.getSid()) + '&' + Qs.stringify(this.strategyParams);
      this.options.body = JSON.stringify(this.strategyParams); // obj = JSON.parse(obj);
      this.options.method = 'POST';
      this.options.headers = { 'Accept': 'application/json', 'Content-Type': 'application/json' };
      let url = '/api/auth-service/resourceStrategy/changeOwner' + '?' + Qs.stringify(this.getSid());
      this.saveFetch(url, this.options);
    },
    submit () {
      let { id, ownerId } = this.formParams;
      this.options.body = Qs.stringify({ id, ownerId, ...this.getSid() });
      this.options.method = 'POST';
      this.options.headers = { 'Content-Type': 'application/x-www-form-urlencoded' };
      this.saveFetch(this.submitUrl, this.options);
    },
    saveFetch (url, options) {
      fetch(url, options)
        .then(response => response.json())
        .then(({ code, message }) => {
          if (code === '00' || code === '000000') {
            this.$Message.success(`保存${message}！`);
            this.$emit('save-success');
            this.cancel();
          } else {
            this.$Message.error(message || '服务器错误！');
            this.resetParams();
          }
        }, reason => {
          this.$Message.error(reason || '服务器错误！');
          this.resetParams();
        });
    },
    ok () {
      this.save_loading = true;
      this.$refs.authForm.validate(valid => {
        // valid ? this.submit() : (this.save_loading = false);
        valid ? (this.isStrategyOp ? this.strategySubmit() : this.submit()) : (this.save_loading = false);
      });
    },
    cancel () {
      this.visible = false;
      this.$emit('input', false);
      this.$refs.authForm.resetFields();
      this.resetParams();
    }
  },
  watch: {
    value (v) {
      this.visible = v;
    }
  },
  mounted () {
    const { id } = this.authData || {};
    this.$parent.$on('authorization', (evt) => {
      this.formParams.ownerId = id;
      this.isStrategyOp = false;
      this.setId(evt);
      this.initData();
    });
    this.$parent.$on('authStrategyEvent', (evt) => {
      this.formParams.ownerId = id;
      this.isStrategyOp = true;
      this.authStrategyCfg.group = evt.group;
      this.authStrategyCfg.strategyId = evt.strategyId;
      this.authStrategyCfg.strategyCode = evt.strategyCode;
      this.authStrategyCfg.strategyName = evt.strategyName;
      this.initStrategy();
      this.$forceUpdate();
    });
  }
};
</script>
