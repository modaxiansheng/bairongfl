<template>
  <div class="section">
    <div class="section-title" v-if="titleName">
      {{titleName}}
    </div>
    <div class="section-body" style="max-width:100%;">
      <Form ref="formRule" :model="formRule" :rules="ruleValidate" label-position="right" :label-width="100" style="width:100%">
        <div v-if="isAddHandle === 'check'">
          <p><span class="form-check">归属规则集</span>{{typeName}}</p>
          <p><span class="form-check">规则编号</span>{{formatRuleCode(formRule.ruleCode)}}</p>
          <p><span class="form-check">规则名称</span>{{formRule.ruleName}}</p>
          <p><span class="form-check">规则说明</span>{{formRule.remark}}</p>
          <p><span class="form-check">规则权重</span>{{formRule.priority}}</p>
          <p><span class="form-check">规则状态</span>{{formRule.status ? '启用' : '停用'}}</p>
          <p><span class="form-check" style="padding: 5px 10px 0;">规则逻辑</span></p>
          <table style="display:inline-block;" border="0" bordercolor="#ffffff" background="#F0F1F5" border-collapse="collapse">
            <tbody v-for="(v,no) in formRule.ruleLogicList" v-bind:key="no">
            <tr style="" v-if="v.isOpen">
              <td class="form-check-logic" style="width: 100px;"></td>
              <td class="form-check-logic" style="width: 20px;">{{v.logicLabel}}</td>
              <td class="form-check-logic" style="width: 20px;">{{v.leftBracks?'(':'&nbsp; '}}</td>
              <td class="form-check-logic" >{{v.label}}</td>
              <td class="form-check-logic" style="width: 30px;text-align:center;">{{v.cascade[1]}}</td>
              <td class="form-check-logic" style="width: 40px;">{{v.param}}</td>
              <td class="form-check-logic" style="width: 10px;">{{v.rightBracks?')':'&nbsp; '}}</td>
            </tr>
            </tbody>
          </table>
        </div>
        <div v-else>
          <FormItem label="归属规则集" >
            <Input v-model="typeName" disabled placeholder="所属规则集" />
          </FormItem>
          <FormItem label="规则编号">
            <Input :value="formatRuleCode(formRule.ruleCode)" disabled placeholder="规则编号由后台直接生成" />
          </FormItem>
          <FormItem label="规则名称" prop="ruleName">
            <Input v-model="formRule.ruleName" :disabled="formRule.ruleTypeStatus == 0 ? true : false" type="text" placeholder="请输入规则名称 如评分高风险 ..."></Input>
          </FormItem>
          <FormItem label="规则说明" prop="remark">
            <Input v-model="formRule.remark" type="textarea" :disabled="formRule.ruleTypeStatus == 0 ? true : false" :autosize="{minRows: 3,maxRows: 5}" placeholder="请输入规则说明..."></Input>
          </FormItem>
          <FormItem label="规则权重" prop="priority">
            <Input style="width:80px" v-model="formRule.priority" number placeholder="最大值100" />
          </FormItem>
          <FormItem label="规则状态" >
            <i-switch v-model="formRule.statusCopy" size="large">
              <span slot="open">启用</span>
              <span slot="close">停用</span>
            </i-switch>
          </FormItem>
          <FormItem label="规则逻辑" >
            <Row>
              <Col span="2">
                <Button :disabled="formRule.ruleTypeStatus == 0 ? true : false" type="primary" size="small"  @click="ruleValidatorHandle('formRule')" >规则校验</Button>
              </Col>
            </Row>
          </FormItem>
          <FormItem
            v-for="(item, index) in formRule.ruleLogicList"
            v-if="false && item.isOpen"
            key="index">
            <Row>
              <Col span="18">
                <FormItem label="test：" prop="cascade"
                          :rules="{required: true, message: 'Item cascade' + item.index +' can not be empty cascade', trigger: 'blur'}">
                  <Cascader :data="formRule.selectItems" v-model="item.cascade" :render-format="format" placeholder="请选择变量名称和计算符号" @on-change="(value,data)=>selectDataCascader(value,data,index,item.cascade)" style="width:300px"></Cascader>
                </FormItem>
                <FormItem label="test：" prop="param"
                          :rules="{required: true, message: 'Item param' + item.index +' can not be empty param', trigger: 'blur'}">
                  <Input type="text" v-model="item.param" style="width:75px" placeholder="请输入数值..."></Input>
                </FormItem>
                <RadioGroup v-model="item.logic" @on-change="updateData" type="button" size="small">
                  <Radio label="&&">且</Radio>
                  <Radio label="||">或</Radio>
                </RadioGroup>
                <Input type="text" v-model="item.value" placeholder="Enter something..."></Input>
              </Col>
              <Col span="4" offset="1">
                <Button type="dashed" long @click="handleAdd1" icon="plus-round">Add item</Button>
                <Button type="ghost" @click="handleRemove1(index)">Delete</Button>
              </Col>
            </Row>
          </FormItem>
          <FormItem disabled :label-width="100" v-for="(item, index) in formRule.ruleLogicList" v-if="item.isOpen" :key="index" >
            <Row style="margin-left: -100px;">
              <Col span="1" style="width: 100px;text-align: center;">
                <span v-if="item.index == 0 || item.isShowLogic == 1 ">&nbsp;&nbsp;&nbsp;</span>
                <FormItem v-else :prop="'ruleLogicList.' + index + '.logic'"
                          :rules="{required: true, message: '请选择值：且、或 ' + '', trigger: 'change'}">
                  <RadioGroup v-model="item.logic" @on-change="updateData" type="button" size="small">
                    <Radio :disabled="formRule.ruleTypeStatus == 0 ? true : false" label="&&">且</Radio>
                    <Radio :disabled="formRule.ruleTypeStatus == 0 ? true : false" label="||">或</Radio>
                  </RadioGroup>
                </FormItem>
              </Col>
              <Col span="20">
                <!--外层row 是为了 且或变成一行，才嵌套的现象-->
                <Row class="last-form-item">
                  <div>
                    <Switch :disabled="formRule.ruleTypeStatus == 0 ? true : false" v-model="item.leftBracks">
                      <span slot="open">(</span>
                      <span slot="close">(</span>
                    </Switch>
                  </div>
                  <div>
                    <FormItem style="padding-left: 5px;" :prop="'ruleLogicList.' + index + '.cascade'"
                              :rules="{required: true, type: 'array',min: 1, message: '请选择变量名称和计算符号', trigger: 'change'}" >
                      <div style="clear:both;display: inline-table;min-width: 390px;">
                        <Cascader :transfer="false" :disabled="formRule.ruleTypeStatus == 0 ? true : false" :data="formRule.selectItems" v-model="item.cascade" :render-format="format" placeholder="请选择变量名称和计算符号" @on-change="(value,data)=>selectDataCascader(index,data)"></Cascader>
                      </div>
                    </FormItem>
                  </div>
                  <div>
                    <!--v-model和:value 要匹配才绑定，label显示用  -->
                    <FormItem :prop="'ruleLogicList.' + index + '.param'" class="special-input-num"
                              :rules="[{required: true, type:'string', message: '请输入数值', trigger: 'blur'},{pattern: /^[0-9]+([.]{1}[0-9]{1,2}){0,1}$/, message: '整数或最多保留两位小数', trigger: 'change'}]">
                      <Input style="width: 90px;" type="text" @on-keyup="updateData" v-model="item.param" :disabled="formRule.ruleTypeStatus == 0" placeholder="请输入数值..."></Input>
                    </FormItem>
                  </div>
                  <div>
                    <Switch :disabled="formRule.ruleTypeStatus == 0 ? true : false" v-model="item.rightBracks">
                      <span slot="open">)</span>
                      <span slot="close">)</span>
                    </Switch>
                  </div>
                  <div>
                    <Button :disabled="formRule.ruleTypeStatus == 0 ? true : false" type="text" @click="handleAdd" size="large" :style="{fontSize: '20px',color: '#3097FE',padding: '0 3px',minWidth:'auto'}" icon="ios-plus-outline" v-if="item.index+1 == formRule.ruleLogicList.length && index < 20"></Button>
                    <Button :disabled="formRule.ruleTypeStatus == 0 ? true : false" type="text" icon='ios-minus-outline' size="large" style="font-size: 20px;color: #EF444D;padding: 0 3px;min-width:auto;" @click="handleRemove(index)" v-else></Button>
                  </div>
                </Row>
              </Col>
            </Row>
          </FormItem>
        </div>
        <FormItem :label-width="1" style="text-align: right; padding-top: 20px; margin-bottom: 0px;">
          <Button v-if="isAddHandle !== 'check'" :loading="loading" type="primary" @click="handleSubmit('formRule')">保存</Button>
          <Button type="ghost" @click="handleReset('formRule')" style="margin-left: 8px">取消</Button>
        </FormItem>
      </Form>
    </div>

    <Modal v-model="isShowValidator" width="500" :transfer="false" :mask-closable="false" ok-text="保存" cancel-text="取消">
      <p slot="header">
        <span>规则校验格式</span>
      </p>
      <div style="text-align:center;">
        <ul>
          <li v-for="(v,no) in formRule.ruleLogicList" style="list-style: none;">&nbsp;
            <Row :gutter="16" v-if="v.isOpen">
              <Col span="1">
                    <span v-if="v.index == 0 || v.isShowLogic == 1 ">
                      &nbsp;
                    </span>
                <span v-else>
                      {{ v.logicLabel}}
                    </span>
              </Col>
              <Col span="1">
                {{ v.leftBracks?'(':'&nbsp; ' }}
              </Col>
              <Col span="16">
                {{ v.label }}
              </Col>
              <Col span="2">
                {{ v.cascade[1] }}
              </Col>
              <Col span="3">
                {{ v.param }}
              </Col>
              <Col span="1">
                {{ v.rightBracks?')':'&nbsp; ' }}
              </Col>
            </Row>
            <Row :gutter="16" v-if="false && v.isOpen && no < formRule.ruleLogicList.length-1">
              <Col span="4">
                {{ v.logicLabel}}
              </Col>
            </Row>
          </li>
        </ul>
      </div>
      <div slot="footer" style="text-align: center;">
        <Button type="primary" size="large" @click="closeModal">关闭</Button>
      </div>
    </Modal>

  </div>
</template>

<script>
/**
 * 参数说明：
 * titleName 标题名称  如  编辑规则
 * isAddHandle 当前操作是新建 true、编辑 false、查看'check'。
 *
 *
 */
export default {
  name: 'RuleAddEdit',
  props: ['titleName', 'isAddHandle', 'ruleType', 'version', 'typeName', 'itemData', 'rulesetKey'],
  data () {
    const validateCascade = (rule, value, callback) => {
      if (value === '') {
        callback(new Error('Please enter your password'));
      } else {
        if (value === 2) {
          callback(new Error('输入值过短！'));
        } else if (value > 2) {
          callback(new Error('输入值过长！'));
        }
        callback(new Error('值过长！'));
      }
      callback();
    };
    const validatePass = (para, rule, value, callback) => {
      callback();
    };
    const validateRuleName = (rule, value, callback) => {
      const pattern = /^[a-zA-Z0-9_-|\u4E00-\u9FA5]|\S\s{4,56}$/;
      if (value) {
        if (!pattern.test(value.trim())) {
          callback(new Error('规则名称不可包含特殊字符，且不能少于四位字符！'));
        }
      }
      callback();
    };
    return {
      ddd: {validator: validatePass.bind(this, 55), message: '565', trigger: 'change'},
      isShowValidator: false,
      cfgRule: {},
      buttonAnd: '且',
      buttonOr: '或',
      logicIndex: 0,
      proList: [{
        value: '1',
        label: '注册'
      }, {
        value: '2',
        label: '登录'
      }, {
        value: '3',
        label: '借款'
      }, {
        value: '4',
        label: '提现'
      }],
      selectOperator: [
        {label: '=', value: '=='},
        {label: '>', value: '>'},
        {label: '>=', value: '>='},
        {label: '<', value: '<'},
        {label: '<=', value: '<='}
      ],
      platformList: [{
        value: '1',
        label: 'WEB'
      }, {
        value: '2',
        label: 'IOS'
      }, {
        value: '3',
        label: 'Android'
      }],
      isShowLog: false,
      loading: false,
      formRule: {
        ruleset: '',
        ruleCode: '',
        ruleName: '',
        remark: '',
        priority: '',
        status: '',
        ruleTypeStatus: 1, /// ruleTypeStatus Filter 0:预置规则，1:自定义规则
        ruleLogicList: [{
          cascade: [],
          field: '',
          leftBracks: false,
          rightBracks: false,
          logic: '&&',
          operator: '',
          param: '',
          paramMax: Infinity,
          paramMin: -Infinity,
          value: 0,
          isOpen: 1,
          index: 1
        }],
        selectItems: [],
        items: [{
          value: '',
          index: 1,
          isOpen: 1
        }]
      },
      ruleValidate: {
        ruleset: [{
          required: true,
          message: '归属规则集是必填项',
          trigger: 'blur'
        }, {
          type: 'array',
          max: 2,
          message: 'Choose two hobbies at best',
          trigger: 'change'
        }

        ],
        ruleCode: [{
          required: false,
          message: '规则编号是必填项',
          trigger: 'blur'
        }, {
          type: 'email',
          message: 'Incorrect email format',
          trigger: 'blur'
        }],
        ruleName: [{
          required: true,
          message: '规则名称是必填项',
          trigger: 'blur'
        }, {
          // pattern: /^[a-zA-Z0-9_-|\u4E00-\u9FA5]|\S\s{4,56}$/,
          // message: '规则名称不可包含特殊字符，且不能少于四位字符！',
          validator: validateRuleName,
          trigger: 'blur'
        }
          // {type: "string", required: true, pattern: schema.pattern.email}
        ],
        remark: [{
          required: false,
          max: 100,
          message: '规则说明长度最多100个汉字',
          trigger: 'blur'
        }],
        priority: [
          {
            // pattern: /^([1-9]|[12]\d)$,
            pattern: /^100$|^([0-9]|[0-9]\d)$/,
            required: true,
            message: '规则权重不能空且只能为小于等于100的数字！',
            trigger: 'change'
          }
        ],
        status: [{
          required: true,
          type: 'string',
          message: '规则状态是必填项',
          trigger: 'change'
        }],
        cascade0: [
          { required: true, pattern: /^\s+$/g, message: 'The name cannot be empty000001', trigger: 'change' }
        ],
        cascade1: [
          { required: true, type: 'array', message: 'The name cannot be empty11', trigger: 'change' }
        ],
        cascade2: [
          { required: true, validator: validateCascade, message: 'The name cannot be empty22', trigger: 'change' }
        ],
        param: [
          { validator: validateCascade, trigger: 'blur' }
        ],
        cascade: [
          { validator: validateCascade, trigger: 'blur' }
        ],
        ruleLogicList: [{
          required: true,
          type: 'array',
          message: '请选择输入值',
          trigger: 'change'
        }]
      }
    };
  },
  components: {
  },
  created () {
    /* 接收新建规则事件 */
    this.$on('createRuleDataEvent', (evt) => {
      /// 每次更改数据watch：itemData都会调用init，添加时不传 ;ruleCode 中有"_yz"时只传id,ruleCode,priority,---status,
      if (this.isAddHandle) {
        this.logicIndex = 0; // 只在创建的时候用
      }
      this.init();
      this.$forceUpdate();
    });
  },
  methods: {
    init: function () {
      // 使用props传递数据  itemData
      // 添加时不传 ;ruleCode 中有"_yz"时只传id,ruleCode,priority,---status,
      if (this.rulesetKey) {
        this.formRule = this.itemData;
        this.formRule.statusCopy = typeof this.formRule.statue === 'boolean' ? this.formRule.status : this.formRule.status === 1;// 1启用 0不启用
        if (this.formRule.jsonstr && this.formRule.jsonstr !== '') {
          this.formRule.jsonObj = this.formRule.jsonstr ? JSON.parse(this.formRule.jsonstr) : {};
          let jsonVal = this.formRule.jsonObj;
          let length = jsonVal.fields ? jsonVal.fields.length : 0;

          /// 逻辑符号 把数据库中 两个以上 这种 ["||",""] 修改为 ["","||"]
          let logicsArr = jsonVal.logics;
          if (logicsArr && logicsArr.length >= 2) {
            logicsArr.unshift(logicsArr[logicsArr.length - 1]); // 从最后添加到第一个位置
            logicsArr.pop(); // 把最后一个符号删除掉
          } else {
            logicsArr = jsonVal.logics;
          }
          jsonVal.logicArr = logicsArr;

          let ruleLogicList = [];
          for (var i = 0; i < length; i++) {
            let ruleLogic = {};
            ruleLogic.leftBracks = !!/^\(/g.test(jsonVal.fields[i]); // 括号
            ruleLogic.rightBracks = !!/\)$/g.test(jsonVal.fields[i]); // 括号
            ruleLogic.field = jsonVal.fields[i].match(/([^()]+)/g)[0];
            ruleLogic.operator = jsonVal.operators[i];
            ruleLogic.cascade = [ruleLogic.field, ruleLogic.operator];

            ruleLogic.logic = jsonVal.logicArr[i];

            ruleLogic.param = parseFloat(jsonVal.params[i]) + '';

            ruleLogic.index = i;
            ruleLogic.isOpen = 1; // 逻辑删除标识  一条
            ruleLogic.value = i + i + i;

            ruleLogicList.push(ruleLogic);
          }
          setTimeout(() => {
            this.formRule.ruleLogicList = ruleLogicList;
            this.logicIndex = ruleLogicList.length > 1 ? ruleLogicList.length - 1 : 0;
            if (this.isAddHandle === 'check') {
              this.ruleLogicLabelHandle();
            }
            this.updateData();
          }, 50);
        }

        this.formRule.items = [
          {
            value: '',
            index: 1,
            logic: '&&',
            isOpen: 1
          }
        ];
        this.formRule.selectOperator = this.selectOperator;

        let selectItems_ = [];

        for (var i = 0; i < this.rulesetKey.length; i++) {
          let operatorArr = [];// 每个规则变量对应的  一组操作符
          let arr = (this.rulesetKey[i].logs && this.rulesetKey[i].logs.split(',')) || [];
          if (/.+\,$/g.test(this.rulesetKey[i].logs)) {
            arr.pop(); // 去除尾部 ,
          }
          arr.forEach(function (v, j) {
            let value = '';
            if (v === '=') {
              value = '==';
            } else {
              value = v;
            }
            let tempObj = {label: v, value: value};
            operatorArr.push(tempObj);
          });

          let selectItem_ = {
            index: i,
            label: this.rulesetKey[i].key_name,
            value: this.rulesetKey[i].rule_key,
            datalogs: this.rulesetKey[i].logs,
            children: operatorArr,
            dataparas: this.rulesetKey[i].paras
          };
          selectItems_.push(selectItem_);
        }

        this.formRule.selectItems = selectItems_;

        this.$forceUpdate();
      }
    },
    handleAdd () {
      this.logicIndex++;
      this.formRule.ruleLogicList.push({
        cascade: [],
        field: '',
        leftBracks: false,
        rightBracks: false,
        logic: '&&',
        operator: '',
        param: '',
        paramMax: Infinity,
        paramMin: -Infinity,
        value: 0,
        index: this.logicIndex,
        isOpen: 1
      });

      this.$forceUpdate();
    },

    handleRemove (index) {
      this.formRule.ruleLogicList[index].isOpen = 0;
      let delIndexMin = false; // 当点击是最小顺序号  且  是打开的 ，进行逻辑显示
      for (let i = 0; i < index; i++) {
        if (this.formRule.ruleLogicList[i].isOpen === 1) {
          delIndexMin = true;
          break;
        }
      }
      if (!delIndexMin) {
        let delIndexMax = index;
        for (let i = index; i < this.formRule.ruleLogicList.length; i++) {
          if (this.formRule.ruleLogicList[i].isOpen === 1) {
            delIndexMax = i; // 当点击是最小顺序号  且  是打开的isOpen==1 ，対后续第一个打开的   加不显示isShowLogic = 1
            break;
          }
        }
        this.formRule.ruleLogicList[delIndexMax].isShowLogic = 1;
      }
      this.$forceUpdate();
    },
    handleChangeOperator (index, value) {
      for (var i = 0; i < this.formRule.selectItems.length; i++) {
        let selectedData = this.formRule.selectItems[i];
        if (selectedData.value === value) {
          this.formRule['selectOperator' + value] = selectedData.selectOperator;
          break;
        }
      }
      this.updateData();
    },
    format (labels, selectedData) {
      const index = labels.length - 1;
      const data = selectedData[index] || false;
      if (data && selectedData.length > 1) {
        let strLength = 44;
        /// 获得字符串实际长度，中文2，英文1
        let valLength = this._getLength(selectedData[0].label);/// selectedData[0].label.length
        let space = '';
        let shiStr = '' + Math.round(valLength / 10);
        switch (shiStr) {
          case '1' :
            space = '                   ';
            break;
          case '2' :
            space = '              ';
            break;
          case '3' :
            space = '    ';
            break;
          default :
            space = '';
        }
        let arr = [];
        for (var i = 0; i < (strLength - valLength); i++) {
          space = space + ' ';
          arr.push('');
        }
        return selectedData[0].label + space + selectedData[1].label;
      }
      return labels[index];
    },
    _getLength (str) {
      /// 获得字符串实际长度，中文2，英文1
      /// 参数 str：要获得长度的字符串
      var realLength = 0, len = str.length, charCode = -1;
      for (var i = 0; i < len; i++) {
        charCode = str.charCodeAt(i);
        if (charCode >= 0 && charCode <= 128) realLength += 1;
        else realLength += 2;
      }
      return realLength;
    },
    selectDataCascader (index, selectData) {

      if (selectData.length > 1) {
        let dataparas = selectData[0].dataparas;
        let itemD = this.formRule.ruleLogicList[index];
        if (dataparas === 'n') {
          itemD.paramMax = Infinity;
          itemD.paramMin = -Infinity;
        } else {
          let paras = dataparas.split(',');
          itemD.paramMax = paras[paras.length - 1] ? parseInt(paras[paras.length - 1]) : Infinity;
          itemD.paramMin = parseInt(paras[0]);
        }
      }

      this.updateData();
    },
    updateData () {
      // 只数据刷新，否则显示不变
      this.$forceUpdate();
    },
    /**
     * rule code replace _yz
     * @param code
     * @reutn String code
     */
    formatRuleCode (code) {
      let ruleCode = '';
      return code ? code.replace('_yz', '') : '';
    },
    ruleValidatorHandle (name) {
      this.$refs[name].validate((valid) => {
        if (valid) {
          let formSubmitConfig;
          var flag = this.ruleValidatorAction(this.formRule.ruleLogicList, function (data) {
            formSubmitConfig = data;
          });
          var str_rule = JSON.stringify(formSubmitConfig);
          var isError = this.isError(str_rule);
          if (isError === true) {
            this.$Message.warning('规则校验格式错误!');
          } else {
            this.$Message.success('规则校验格式正确!');
          }
          this.isShowValidator = true;
        } else {
          this.$Message.error('规则校验格式错误!');
        }
      });
      this.ruleLogicLabelHandle();
    },
    ruleLogicLabelHandle () {
      // 匹配label
      this.formRule.ruleLogicList && this.formRule.ruleLogicList.map(item => {
        this.formRule.selectItems.map(o => {
          if (item.cascade[0] === o.value) {
            item.label = o.label;
          }
        });
        if (item.logic === '&&') {
          item.logicLabel = '且';
        }
        if (item.logic === '||') {
          item.logicLabel = '或';
        }
      });
    },
    ruleValidatorAction: function (arr, fn) {
      // logics
      var empty = []; //
      var fields = []; // 选择规则  包含左右括号 fields:(j_shut_down,j_shut_down),j_shut_down
      var operators = []; // 运算符  operators:==,==,==
      var params = []; // 输入参数 params:1,1,1
      var logics = []; // 关系 logics:&&,||
      var data = null;
      arr.forEach(function (v, i, arr) {
        if (v.isOpen === 1) {
          if (/^\s*$/g.test(v.param)) {
            empty.push(i);
          }
        }
      });
      if (empty.length) {
        this.$Message.warning('输入条件不能为空，请输入');
        return false;
      }
      /// debugger
      arr.forEach(function (v, i, arr) {
        // debugger
        if (v.isOpen === 1) {
          var hiddenFields = (v.leftBracks ? '(' : '') + v.cascade[0] + (v.rightBracks ? ')' : '');// v.cascade[0] v.field
          // console.log(i+"field     "+hiddenFields+"  ==",v.field)
          fields.push(hiddenFields);
          operators.push(v.cascade[1]);// v.operator
          params.push(v.param);
          logics.push(v.logic);
        }
      });
      /// 逻辑符号取两个表达式之间的值，把最后一个符号删除掉 old
      /// logics.pop()
      /// 逻辑符号 把数据库中 两个以上 这种 ["||",""] 修改为 ["","||"] 把第一个位置删除掉
      logics.shift();

      data = {
        fields: fields.join(','),
        operators: operators.join(','),
        params: params.join(','),
        logics: logics.join(',') /// logics : encodeURIComponent(logics.join(','))
      };

      // return;
      fn && fn(data);
      return true;
    },
    isError: function (str) {
      var r = /[)(]/gm,
        r2 = /\([^()]*\)/gm,
        newStr = str;
      newStr = newStr.replace(r2, '');
      if (r2.test(newStr)) {
        arguments.callee(newStr);
      } else {
        return r.test(newStr);
      }
    },
    handleAdd1 () {
      this.logicIndex++;

      this.formRule.items.push({

        value: '',
        logic: '&&',
        index: this.logicIndex,
        isOpen: 1
      });
      this.$forceUpdate();
    },
    handleRemove1 (index) {
      this.formRule.items[index].isOpen = 0;
      this.$forceUpdate();
    },
    handleSubmit (name) {
      this.$forceUpdate();
      this.loading = true;
      setTimeout(() => {
        this.loading = false;
      }, 1500);

      this.$refs[name].validate((valid) => {
        if (valid) {
          this.formSubmit();
        } else {
          this.$Message.error('规则校验格式错误!');
        }
      });

    },
    handleReset (name) {
      if (this.isAddHandle !== 'check') {
        this.$refs[name].resetFields();
      }
      this.$emit('cancel-data', {}, true);
    },
    formSubmit () {
      var cfg = {
        status: this.formRule.statusCopy ? 1 : 0, // 1启用 0不启用
        ruleType: this.ruleType,
        ruleName: this.formRule.ruleName,
        ruleCode: this.formRule.ruleCode,
        remark: this.formRule.remark,
        priority: this.formRule.priority,
        typeVersion: this.version,
        id: this.formRule.id || '',
        style: 6 // 1基础班规则2标准版贷前规则3标准版贷中规则，4策略API，5验证管理
      };
      // id 新增时不传、编辑时必传
      // 添加时不传 ;ruleCode 中有"_yz"时只传id,ruleCode,priority,---status,
      if (this.isAddHandle) {
        for (var item in cfg) {
          if (item === 'id' || item === 'ruleCode') {
            delete cfg[item];
          }
        }
      }

      //
      //= ==========================新建编辑验证===============================
      //

      let formSubmitConfig = {};
      var flag = this.ruleValidatorAction(this.formRule.ruleLogicList, function (data) {
        formSubmitConfig = data;
      });

      var str_rule = JSON.stringify(formSubmitConfig);
      var isError = this.isError(str_rule);
      if (isError === true) {
        this.$Message.error('规则校验格式错误!');
        return;
      } else {
        // this.$Message.success('规则校验格式正确!')
      }

      for (var itemC in formSubmitConfig) {
        if (!cfg[itemC]) {
          cfg[itemC] = formSubmitConfig[itemC];
        }
      }

      if (flag) {
        this.cfgRule = cfg;
        this.$emit('set-data', this.cfgRule, true);
      }
      // 重置表单
      /// this.handleReset('formRule');
      this.$refs[name].resetFields();
    },
    closeModal: function () {
      this.isShowValidator = false;
    }
  },
  mounted: function () {
    this.init();
  },
  watch: {
    // 监控itemData变量变化的时候，自动执行此函数
    itemData: {
      handler: function (val, oldVal) {
        this.itemData = val;
        // 数据变更时再次更新视图
        this.init();
      },
      deep: true
    }
  }
};
</script>

<style>
  .section .section-body .form-check{
    width: 100px;
    display:inline-block;
    text-align:right;
    padding: 5px 10px;
  }
  .section .section-body .form-check-logic{
    background-color:#F0F1F5;
    height: 20px;
    border: none;
  }
  .section .special-input-num .ivu-form-item-error-tip{
    white-space: nowrap;
  }
  .section .ivu-form-item .ivu-form-item{
    margin-bottom: 0;
  }
  .section .last-form-item>div{
    float: left;
    padding-left: 20px;
  }
  .section .last-form-item>div:first-child{
    padding: 0;
  }
</style>
