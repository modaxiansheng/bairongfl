<template>
  <Modal v-model="visible" :title="title" @on-cancel="cancel" :width="width">
    <span>启用预置规则，将会覆盖您当前的部分规则，可能会影响您的风险政策，受影响的规则情况如下，请确认是否启动预置规则：</span>
    <TableMergeCell style="margin: 16px 0;" height="320px" :columns="columnsPresetRule" :data="strategyDataGroup"></TableMergeCell>
    <template slot="footer">
      <Button type="primary" :loading="save_loading" @click="ok">确认启用</Button>
      <Button type="text" @click="cancel">取消</Button>
    </template>
  </Modal>
</template>
<script>
/**
 * 风险提示弹出框
 * 使用说明：
 * 如弹框引用 <PresetRuleChange width="680" @save-confirm="saveConfirmOk"></PresetRuleChange>
 *  发消息来 presetRuleChangeEvent,如下：
 *  this.$emit('presetRuleChangeEvent', {
        type: 6, // 业务分类 1:贷前;5:验证;6:贷中,必传项
        ruleType: 'Rule_W_SpecialList_c_pdl', // 规则集编码
        typeVersion: '1.0', // 规则集版本号
        ids: ['246725', '246726'] // 公司内部预置规则id数组
      });
 * 2019.3.4
 * hl
 */
import TableMergeCell from '../table/TableMergeCell';
import Cookies from 'js-cookie';
import Qs from 'qs';
export default {
  name: 'PresetRuleChange',
  components: {
    TableMergeCell
  },
  props: {
    value: {type: Boolean, default: false},
    title: {type: String, default: '风险提示'},
    width: {default: 600}
  },
  data () {
    return {
      loading: false,
      save_loading: false,
      visible: this.value,
      authStrategyCfgEg: {
        type: 6, // 业务分类 1:贷前;5:验证;6:贷中,必传项
        ruleType: 'Rule_W_SpecialList_c_pdl', // 规则集编码
        typeVersion: '1.0', // 规则集版本号
        ids: ['246725', '246726'] // 公司内部预置规则id数组
      },
      authStrategyCfg: {},
      options: {
        method: 'GET',
        headers: {'Accept': 'application/json', 'Content-Type': 'application/json'},
        credentials: 'same-origin', // 'same-origin', include
        mode: 'cors',
        cache: 'force-cache'
      },
      columnsPresetRule: [
        {
          title: '规则编号',
          width: 85,
          merge: 'ruleCode',
          key: 'ruleCode'
        },
        {
          title: '修改参数',
          width: 85,
          key: 'nameChange'
        },
        {
          title: '当前规则',
          render: (h, params) => {
            let isLogic = !!(params.row.currentRule && typeof params.row.currentRule === 'object');
            let names = isLogic ? params.row.currentRule : [];
            let liArr = [];
            for (let i = 0; i < names.length; i++) {
              let itemSpan = h('span', names[i]);
              let itemLi = h('li', {
                style: {'margin-bottom': '3px', 'list-style': 'none'}
              }, [itemSpan]);
              liArr.push(itemLi);
            }
            return isLogic ? h('ul', [liArr]) : h('span', params.row.currentRule);
          },
          key: 'currentRule'
        },
        {
          title: '变更后规则',
          render: (h, params) => {
            let isLogic = !!(params.row.afterRule && typeof params.row.afterRule === 'object');
            let names = isLogic ? params.row.afterRule : [];
            let liArr = [];
            for (let i = 0; i < names.length; i++) {
              let itemSpan = h('span', names[i]);
              let itemLi = h('li', {
                style: {'margin-bottom': '3px', 'list-style': 'none'}
              }, [itemSpan]);
              liArr.push(itemLi);
            }
            return isLogic ? h('ul', [liArr]) : h('span', params.row.afterRule);
          },
          key: 'afterRule'
        }
      ],
      strategyDataGroup: []
    };
  },
  methods: {
    // 一个编号下面，多个数组表达式组成的字符数据
    ruleLogicStr (jsonVal) {
      let length = jsonVal.fieldsZn ? jsonVal.fieldsZn.length : 0;
      /// 逻辑符号 把数据库中 两个以上 这种 ["||",""] 修改为 ["","||"]
      // let logicsArr = jsonVal.logics;
      // if (logicsArr && logicsArr.length >= 2) {
      //   logicsArr.unshift(logicsArr[logicsArr.length - 1]); // 从最后添加到第一个位置
      //   logicsArr.pop(); // 把最后一个符号删除掉
      // } else {
      //   logicsArr = jsonVal.logics;
      // }
      // jsonVal.logicArr = logicsArr;
      // console.log('logics', jsonVal.logics, logicsArr)

      let ruleLogicList = [];
      let expression = '';
      for (let i = 0; i < length; i++) {
        let ruleLogic = {};
        ruleLogic.leftBracks = /^\(/g.test(jsonVal.fieldsZn[i]) ? ' ( ' : ' '; // 括号
        // ruleLogic.rightBracks = !!/\)$/g.test(jsonVal.fieldsZn[i]); // 括号
        ruleLogic.rightBracks = /\)$/g.test(jsonVal.params[i]) ? ' ) ' : ' '; // 括号
        ruleLogic.field = jsonVal.fieldsZn[i].match(/([^()]+)/g)[0];
        ruleLogic.operator = ' ' + jsonVal.operators[i] + ' ';
        ruleLogic.logic = jsonVal.logics[i] + ' ';
        // ruleLogic.param = parseFloat(jsonVal.params[i]) + '';
        ruleLogic.param = parseFloat(jsonVal.params[i].match(/([^()]+)/g)[0]) + ' ';
        ruleLogic.index = i;
        expression = ruleLogic.leftBracks + ruleLogic.field + ruleLogic.operator + ruleLogic.param + ruleLogic.rightBracks + ruleLogic.logic;
        ruleLogicList.push(expression);
      }
      return ruleLogicList;
    },
    ruleDataFormat (item, columnName, ruleItem) {
      Object.keys(item).forEach((key, i) => {
        switch (key) {
          case 'ruleName':
            if (item.ruleName) {
              ruleItem.ruleName = {...ruleItem.ruleName, ruleCode: item.ruleCode, nameChange: '规则名称'};
              ruleItem.ruleName[columnName] = item.ruleName;
            }
            break;
          case 'priority':
            if (item.priority + '' === '0' || item.priority >= 1) {
              ruleItem.priority = {...ruleItem.priority, ruleCode: item.ruleCode, nameChange: '规则权重'};
              ruleItem.priority[columnName] = item.priority;
            }
            break;
          case 'status':
            if (item.status + '' === '0' || item.status + '' === '1') {
              ruleItem.status = {...ruleItem.status, ruleCode: item.ruleCode, nameChange: '规则状态'};
              ruleItem.status[columnName] = item.status + '' === '1' ? '启用' : '禁用';
            }
            break;
          case 'jsonStr':
            if (item.jsonStr && item.jsonStr.fieldsZn) {
              ruleItem.jsonStr = {...ruleItem.jsonStr, ruleCode: item.ruleCode, nameChange: '规则逻辑'};
              ruleItem.jsonStr[columnName] = this.ruleLogicStr(item.jsonStr);
            }
            break;
        }
      });
      return ruleItem;
    },
    initStrategy () {
      this.loading = true;
      // this.options.method = 'GET';
      this.options.method = 'POST';
      let url = '/api/rulecenter-service/newBRule/enablingPresetRuleChangeContrast';
      if (this.options.method === 'GET') {
        url = url + '?' + Qs.stringify(this.getSid()) + '&' + Qs.stringify(this.authStrategyCfg);
        delete this.options.body;
      } else {
        // this.options.body = Qs.stringify(this.getSid()) + '&' + Qs.stringify(this.authStrategyCfg);
        url = url + '?' + Qs.stringify(this.getSid())
        this.options.body = JSON.stringify(this.authStrategyCfg);// 转换为一个 JSON字符串
      }
      fetch(url, this.options)
        .then(response => response.json())
        .then(({code, data, message}) => {
          this.loading = false;
          if (code === '000000') {
            let groupDataArr = [];
            // let demoData = JSON.parse('{"code":"000000","data":[{"afterAlterationRule":{"id":271122,"jsonStr":{"ruleType":"Rule_C_AirTravel_d1","ruleName":"航空消费能力较低","priority":10,"operators":["<="],"fieldsZn":["航空消费能力等级"],"ruleCode":"FAA001","params":["23"],"logics":[""],"fields":["i_AirExpense_score"]},"priority":null,"ruleCode":"FAA001","ruleName":"","status":null},"currentRule":{"id":471229,"jsonStr":{"ruleType":"Rule_C_AirTravel_d1","ruleName":"航空消费能力较低","priority":10,"operators":["<="],"fieldsZn":["航空消费能力等级"],"ruleCode":"FAA001","params":["25"],"logics":[""],"fields":["i_AirExpense_score"]},"priority":null,"ruleCode":"FAA001","ruleName":"","status":null}},{"afterAlterationRule":{"id":271123,"jsonStr":{"ruleType":"Rule_C_AirTravel_d1","ruleName":"航空消费能力较高","priority":5,"operators":[">=","<="],"fieldsZn":["航空消费能力等级","航空消费能力等级"],"ruleCode":"FAA002","params":["25","59"],"logics":["且",""],"fields":["i_AirExpense_score","i_AirExpense_score"]},"priority":null,"ruleCode":"FAA002","ruleName":"","status":null},"currentRule":{"id":471230,"jsonStr":{"ruleType":"Rule_C_AirTravel_d1","ruleName":"航空消费能力较高","priority":5,"operators":[">=","<="],"fieldsZn":["航空消费能力等级","航空消费能力等级"],"ruleCode":"FAA002","params":["25","61"],"logics":["且",""],"fields":["i_AirExpense_score","i_AirExpense_score"]},"priority":null,"ruleCode":"FAA002","ruleName":"","status":null}}],"message":"成功"}');
            // let data = demoData.data;
            if (data && data.length >= 1) {
              this.visible = true;
              data.forEach(item => {
                // 增加列字段columnName currentRule afterRule
                let currentRule = this.ruleDataFormat(item.currentRule, 'currentRule', {})
                let mergeRule = this.ruleDataFormat(item.afterAlterationRule, 'afterRule', currentRule)
                // mergeRule.jsonStr.afterRule = 'afterAlterationRuleafterAlterationRuleafterAlterationRuleafterAlterationRule'.split('e')
                Object.keys(mergeRule).forEach((key, i) => {
                  groupDataArr.push(mergeRule[key]);
                });
              });
            } else {
              this.visible = false;
              this.$emit('save-confirm');
            }
            this.strategyDataGroup = groupDataArr;
          } else {
            this.$Message.error(message || '服务器错误！');
          }
        }, reason => {
          this.$Message.error(reason || '服务器错误！');
        });
    },
    getSid (sessionId = Cookies.get('BR_COMPASS_SESSIONID')) {
      return {sessionId, t: Date.now()};
    },
    resetParams () {
      this.save_loading = false;
    },
    ok () {
      // this.save_loading = true;
      this.$emit('save-confirm');
      this.visible = false;
      this.resetParams();
    },
    cancel () {
      this.visible = false;
      this.$emit('input', false);
      this.resetParams();
    }
  },
  watch: {
    value (v) {
      this.visible = v;
    }
  },
  mounted () {
    this.$parent.$on('presetRuleChangeEvent', (evt) => {
      this.authStrategyCfg.type = evt.type;
      this.authStrategyCfg.typeVersion = evt.typeVersion;
      this.authStrategyCfg.ruleType = evt.ruleType;
      this.authStrategyCfg.ids = evt.ids;
      this.initStrategy();
      this.$forceUpdate();
    });
  }
};
</script>
