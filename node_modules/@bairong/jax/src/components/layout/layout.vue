<style lang="less">
  @import './styles/layout.less';
</style>
<template>
  <div class="main" :class="{'main-hide-text': shrink}">
    <div class="sidebar-menu-con" :class="{dark: isDark}" :style="{width: shrink?'60px':'200px'}">
      <shrinkable-menu
        :shrink="shrink"
        :icon-size="iconSize"
        :showSubIcon="showSubIcon"
        @on-change="handleSubmenuChange"
        :theme="menuTheme"
        :open-names="getOpenMenuNames"
        :active-name="getActiveName"
        :menu-list="menuList">
        <div slot="top" class="logo-con theme-main-color">
          <img v-show="!shrink" :src="resourceConf.layoutLogoURL" class="logo-big" key="max-logo"/>
          <img v-show="shrink" :src="resourceConf.layoutMinLogoURL" class="logo-small" key="min-logo"/>
        </div>
      </shrinkable-menu>
      <div class="navicon-con">
        <div :style="{transform: 'rotateZ(' + (this.shrink ? '-180' : '0') + 'deg)'}" @click="toggleClick">
          <span v-if="!this.shrink">收起</span><Icon custom="br-icon br-icon-shrink" size="24"></Icon>
        </div>
      </div>
    </div>
    <div class="main-header-con" :style="{paddingLeft: shrink?'60px':'200px'}">
      <div class="main-header theme-main-color">
        <div v-if="isShowTitle" class="header-title">{{headerTitle}}</div>
        <div class="header-middle-con">
          <top-menu class="theme-main-color" v-if="toolbarList.length" :toolbarList="toolbarList" :activeName="toolbarActiveName" @changeTopMenu="handleChangeTopMenu"></top-menu>
        </div>
        <div class="header-avator-con">
          <full-screen v-if="showFullScreen" v-model="isFullScreen" @on-change="fullscreenChange"></full-screen>
          <theme-switch v-if="showThemeSwitch"></theme-switch>
          <slot name="userContent">
            <user-menu></user-menu>
          </slot>
        </div>
      </div>
    </div>
    <div class="single-page-con" :style="{left: shrink?'60px':'200px'}">
      <div class="single-page">
        <P-breadcrumb v-if="!isShowBeadcrumb" :separator="separator"></P-breadcrumb>
          <router-view  @on-setOpenMenu="setOpenMenu" ></router-view>
      </div>
    </div>
  </div>
</template>
<script>
import Cookies from 'js-cookie';
import _ from 'lodash';
import { http, resourceConf } from '../../utils/';
import { TopMenu, ShrinkableMenu, FullScreen, ThemeSwitch, PBreadcrumb } from '@bairong/jax-core';
import userMenu from './common/userMenu';

export default {
  name: 'Layout',
  components: {
    ShrinkableMenu,
    FullScreen,
    ThemeSwitch,
    TopMenu,
    PBreadcrumb,
    userMenu
  },
  props: {
    isOpenDefautlMenu: {
      type: Boolean,
      default: true
    },
    headerTitle: {
      type: String,
      default: ''
    },
    showFullScreen: {
      type: Boolean,
      default: false
    },
    showThemeSwitch: {
      type: Boolean,
      default: false
    },
    changeTopMenu: {
      type: Function
    },
    iconSize: {
      Number,
      default: 18
    },
    showSubIcon: {
      type: Boolean,
      default: true
    },
    separator: {
      type: String
    },
    beadcrumbException: {
      type: Array,
      default: () => {
        return ['/home', '/404'];
      }
    }
  },
  data () {
    return {
      shrink: !!+Cookies.set('isShrink'),
      isFullScreen: false,
      openedSubmenuArr: [],
      activeName: '',
      saveLoading: false,
      resourceConf
    };
  },
  computed: {
    menuList () {
      if ( this.isOpenDefautlMenu && this.$store.state.user.sideList.length) {
        this.openDefaultMenu();
      }
      return this.$store.state.user.sideList;
    },
    toolbarList () {
      return this.$store.state.user.toolbarList;
    },
    toolbarActiveName () {
      const toolbarList = this.$store.state.user.toolbarList;
      const activeMenu = toolbarList.filter(item => !!item.className) || [];
      return activeMenu.length ? activeMenu[0].name : '';
    },
    /**
     * 取得一级目录展开名称，
     * return Array
     * */
    getOpenMenuNames () {
      const names = _.map(this.$route.path.split('/')).filter(path => path !== '') || '';
      return ['/' + names[0]] || this.openedSubmenuArr;
    },
    /**
     * 取得当前二级菜单
     * */
    getActiveName () {
      const parentPath = this.$route.meta.parentPath;
      return parentPath || this.activeName || this.$route.path;
    },
    menuTheme () {
      return this.$store.state.app.menuTheme;
    },
    isShowBeadcrumb () {
      const { name, path } = this.$route;
      return this.beadcrumbException.indexOf('/' + name) > -1 || this.beadcrumbException.indexOf(path) > -1;
    },
    isShowTitle () {
      return this.headerTitle !== '';
    },
    isDark () {
      return this.$store.state.app.menuTheme === 'dark';
    }
  },
  methods: {
    init () {
      // let openMenuName = this.$route.name;
      // this.openedSubmenuArr = [openMenuName];
      //  let pathArr = regExp.setCurrentPath(this, this.$route.name);
      //  this.$store.commit('updateMenulist');
      //  if (pathArr.length >= 2) {
      //    this.$store.commit('addOpenSubmenu', pathArr[1].name);
      //  }
      // this.userName = Cookies.get('user');
    },
    cookieExtend () {
      return http.DOMAIN.includes('100credit.com') ? [{ path: '/', domain: '100credit.com' }] : [];
    },
    toggleClick () {
      this.shrink = !this.shrink;
      Cookies.set(...['isShrink', this.shrink ? 1 : 0].concat(this.cookieExtend()));
    },
    handleSubmenuChange (val) {
      this.activeName = val;
    },
    fullscreenChange (isFullScreen) {
    },
    handleChangeTopMenu ({ id, url }) {
      this.$router.push({ path: url });
      this.$emit('on-changeTopMenu', id);
      this.activeName = url;
    },
    /**
     * 首次打开时，显示home，再刷新显示默认第一个菜单
     * */
    openDefaultMenu () {
      let menuList = this.$store.state.user.sideList;
      let defaultMenu = menuList[0].children && menuList[0].children.length ? menuList[0].children[0].path : menuList[0].path;
      let hashName = this.$route.name;
      let noOpenDefautlMenu = +Cookies.get('NOODM') || 0;
      if (hashName === 'home' && !noOpenDefautlMenu) {
        this.$router.push({ path: defaultMenu });
      }
      Cookies.remove(...['NOODM'].concat(this.cookieExtend()));
    },
    /**
     * 手动设置展开一级目录,当前二级菜单
     * @param data{}
     * */
    setOpenMenu (data) {
      this.openedSubmenuArr = [data.openMenuName];
      this.activeName = data.activeName;
    }
  },
  mounted () {
    this.init();
  }
};
</script>
