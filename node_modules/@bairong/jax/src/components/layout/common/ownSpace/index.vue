
<template>
  <div>
    <Modal v-model="showModal" :mask-closable="false" width="500" @on-cancel="cancel">
      <h3 slot="header">修改密码</h3>
      <Form :model="formPassword" label-position="right" :label-width="100" ref="formPasswordValidate"
            :rules="ruleValidate">
        <FormItem label="用户名:">
          <span>{{userName}}</span>
        </FormItem>
        <FormItem label="原密码:" prop="oldPassword">
          <Input type="password" v-model="formPassword.oldPassword" placeholder="请输入原密码"/>
        </FormItem>
        <FormItem label="新密码:" prop="newPassword">
          <Input type="password" v-model="formPassword.newPassword" placeholder="请输入新密码，必须同时包含数字和字母"/>
        </FormItem>
        <FormItem label="确认密码:" prop="confirmPassword">
          <Input type="password" v-model="formPassword.confirmPassword" placeholder="请输入确认密码"/>
        </FormItem>
      </Form>
      <div slot="footer">
        <Button type="primary" :loading="saveLoading" @click="save('formPasswordValidate')">保存</Button>
        <Button @click="cancel">取消</Button>
      </div>
    </Modal>
  </div>
</template>
<script>
import md5 from 'md5';

export default {
  name: 'ownSapce',
  components: {
  },
  props: {
    isShowOwnSpace: {
      type: Boolean,
      default: false
    }
  },
  data () {
    const validateOldPassword = (rule, value, callback) => {
      if (/^\s*$/g.test(value)) {
        callback(new Error('请输入原密码'));
      }
      /* if (!/^(?![0-9_!@#$%^&*()]+$)(?![a-zA-Z_!@#$%^&*()]+$)(?![_!@#$%^&*()]+$)[0-9A-Za-z_!@#$%^&*()]{6,16}$/g.test(value)) {
          callback(new Error("密码由6-16位数字和字母组成，且必须同时包含数字和字母！"));
        } */
      callback();
    };
    const validateNewPassword = (rule, value, callback) => {
      if (/^\s*$/g.test(value)) {
        callback(new Error('请输入新密码'));
      }
      if (!/^(?![0-9_!@#$%^&*()]+$)(?![a-zA-Z_!@#$%^&*()]+$)(?![_!@#$%^&*()]+$)[0-9A-Za-z_!@#$%^&*()]{6,16}$/g.test(value)) {
        callback(new Error('密码由6-16位数字和字母组成，且必须同时包含数字和字母！'));
      }
      if (this.formPassword.oldPassword === this.formPassword.newPassword) {
        callback(new Error('新旧密码不能相同'));
      }
      callback();
    };

    const validateConfirmPassword = (rule, value, callback) => {
      if (/^\s*$/g.test(value)) {
        callback(new Error('请输入确认密码'));
      }
      if (!/^(?![0-9_!@#$%^&*()]+$)(?![a-zA-Z_!@#$%^&*()]+$)(?![_!@#$%^&*()]+$)[0-9A-Za-z_!@#$%^&*()]{6,16}$/g.test(value)) {
        callback(new Error('密码由6-16位数字和字母组成，且必须同时包含数字和字母！'));
      }
      if (this.formPassword.newPassword !== this.formPassword.confirmPassword) {
        callback(new Error('两次输入密码必须相同'));
      }
      callback();
    };

    return {
      saveLoading: false,
      showModal: false,
      formPassword: {
        oldPassword: '',
        newPassword: '',
        confirmPassword: ''
      },
      ruleValidate: {
        oldPassword: [
          { required: true, validator: validateOldPassword, trigger: 'blur' }
        ],
        newPassword: [
          { required: true, validator: validateNewPassword, trigger: 'blur' }
        ],
        confirmPassword: [
          { required: true, validator: validateConfirmPassword, trigger: 'blur' }
        ]
      }
    };
  },
  computed: {
    userName () {
      return this.$store.state.user.userName;
    }

  },
  methods: {
    /**
     * 重置按钮
     * */
    resetLoading: function () {
      this.saveLoading = true;
      setTimeout(() => {
        this.saveLoading = false;
      }, 1500);
    },
    cancel: function () {
      console.log('lineNum:', '114', 'class:', 'cancel');
      this.resetFields();
      this.$emit('hideOwnSpace');
    },
    resetFields: function () {
      this.$refs['formPasswordValidate'].resetFields();
    },
    save: function (name) {
      this.$refs[name].validate((valid) => {
        if (valid) {
          let params = {
            oldPassword: md5(this.formPassword.oldPassword),
            newPassword: md5(this.formPassword.newPassword)
          };
          this.$store.dispatch('user/editPassword', params);
        } else {
          this.$Message.error('原密码为空或新密码格式有误！');
          this.resetLoading();
        }
      });
    }
  },
  mounted () {
    this.showModal = this.isShowOwnSpace;
  },
  watch: {
    isShowOwnSpace (val) {
      this.showModal = val;
    }
  }
};
</script>
