<template>
  <div class="music-wrap">
    <div class="my-music">
      <div class="music-body">
        <Icon type="play" v-show="!audioToggle" @click="musicToggle()"></Icon>
        <Icon type="pause" v-show="audioToggle" @click="musicToggle()"></Icon>
      </div>
      <div class="music-length">
        <input type="range" min="0" max="100" v-model="length" @input="changeLength">
      </div>
      <div class="music-duration">
        {{Math.floor(nowDuration/60)+':'+(nowDuration%60/100).toFixed(2).slice(-2)}}/{{Math.floor(duration/60)+':'+(duration%60/100).toFixed(2).slice(-2)}}
      </div>
      <div class="music-voice">
        <Icon v-show="+voice" type="volume-high" @click="voiceToggle">
        </Icon>
        <Icon v-show="!+voice" type="android-volume-off" @click="voiceToggle">
        </Icon>
        <div class="voice-range" v-show="voiceShow">
          <input type="range" min="0" max="100" v-model="voice" @input="changeVoice()">
        </div>
      </div>
      <div class="down-load-file" v-show="downLoadText">
        <a :href="src + paramsString()" :download="downLoadText">
          <Icon type="archive"></Icon>
        </a>
      </div>
      <audio :ref="'audio' + id" style="display:none;" :src="musicUrl" controls="controls" type="audio/wav">
      </audio>
    </div>
  </div>
</template>

<script>
/**
 * @author jun.li@100credit.com
 * @prop { String } src 音频的请求路径(必填)
 * @prop { Object } params 请求参数
 * @prop { Number } initVolume 初始音量（1-100）
 * @prop { Boolean } autoPlay 是否自动播放
 * @prop { String } downLoadText 下载文件的名字（不传则不开启下载功能）
 *
 * @method musicToggle
 * @param { bool } 切换开关播放状态（不传参数默认切换到相反的状态）
 *
 * @event audioToggle 状态切换完后触发
 * @type { Boolean } 当前播放状态
 *
 * @event ended 音频播放完后触发
 * @type { Object } 当前音频的params用来区分结束的是哪个音频
 */

import xhr from '../utils/xhr';

xhr.defaultConfig = {
  responseType: 'arraybuffer'
};
let id = 1; // 自增保证每个audio都是唯一的
let currentPlay = null; // 下次播放之前把正在播放的audio暂停

export default {
  name: 'BrMusic',
  props: {
    // 请求路径
    src: {
      type: String,
      require: true
    },
    // 请求参数
    params: {
      type: Object
    },
    // 初始音量
    initVolume: {
      type: Number,
      default: 50
    },
    // 自动播放
    autoPlay: {
      type: Boolean,
      default: true
    },
    downLoadText: {
      type: String
    }
  },
  data () {
    return {
      audioToggle: false,
      length: 0,
      duration: null,
      nowDuration: 0,
      voiceShow: false,
      voice: this.initVolume,
      musicUrl: '',
      id: 1
    };
  },
  methods: {
    // audio开关
    musicToggle (bool) {
      this.audioToggle = bool === undefined ? !this.audioToggle : bool;
      if (this.audioToggle && !this.musicUrl) {
        this.firstOpen().then(() => {
          // 监听音乐正在播放
          currentPlay && currentPlay.pause();
          this.$refs['audio' + this.id].play();
          currentPlay = this.$refs['audio' + this.id];
          this.$refs['audio' + this.id].addEventListener('timeupdate', this.audioListener, true);
          this.$refs['audio' + this.id].addEventListener('ended', () => {
            this.$emit('ended', this.params);
          }, false);
        }, err => {
          // console.log(err);
          this.$emit('on-error', err);
        });
      } else {
        if (this.audioToggle) {
          currentPlay && currentPlay.pause();
          this.$refs['audio' + this.id].play();
          currentPlay = this.$refs['audio' + this.id];
        } else {
          this.$refs['audio' + this.id].pause();
          currentPlay = null;
        }
        this.$emit('audioToggle', this.audioToggle);
      }
    },
    // 请求音频文件
    firstOpen () {
      return xhr({
        type: 'GET',
        url: this.src,
        data: this.params || {},
        success: (res) => {
          let audioBuffer = res.slice();
          let ctx = new AudioContext();
          ctx.decodeAudioData(audioBuffer, (buffer) => {
            // 处理成功返回的数据类型为AudioBuffer
            this.duration = buffer.duration;
          }, (e) => {
            // console.info('处理出错');
            this.$emit('on-error', e);
          });
          let urlObject = window.URL || window.webkitURL || window;
          let downloadData = new Blob([res], {type: 'audio/wav'});
          this.musicUrl = urlObject.createObjectURL(downloadData);
        },
        error: function (err) {
          // console.log(res);
          this.$emit('on-error', err);
        }
      });
    },
    // 监听audio播放进度，单独写一个函数组件注销时移除监听事件
    audioListener () {
      // 修改目前的ranger位置
      this.length = this.duration ? (this.$refs['audio' + this.id].currentTime * 100 / this.duration) : 0;
      // 修改目前的播放时长
      this.nowDuration = this.$refs['audio' + this.id].currentTime;
      if (parseInt(this.nowDuration) >= parseInt(this.duration)) {
        this.audioToggle = false;
      }
    },
    changeLength () { // 调节进度
      if (this.musicUrl) {
        this.$refs['audio' + this.id].currentTime = this.length * this.duration / 100;
      }
    },
    voiceToggle () { // 调节音量显示
      if (this.musicUrl) {
        this.voiceShow = !this.voiceShow;
      }
    },
    changeVoice () { // 调节音量
      this.$refs['audio' + this.id].volume = this.voice / 100;
    },
    paramsString () {
      if (this.params) {
        let string = '?';
        for (let key in this.params) {
          string += key + '=' + this.params[key] + '&';
        }
        return string.slice(0, -1);
      }
      return 'javascript:;';
    }
  },
  mounted () {
    this.id = id++;
    if (this.autoPlay) {
      this.musicToggle();
    }
  },
  beforeDestroy () {
    this.$refs['audio' + this.id].removeEventListener('timeupdate', this.audioListener, true);
  }
};
</script>

<style lang="less" scoped>
.music-wrap {
  &::before,
  &::after {
    content: '';
    display: block;
    clear: both;
  }
}

.my-music {
  float: left;
  height: 30px;
  padding: 6px;
  background: #eee;

  > div {
    float: left;
  }

  .music-body {
    width: 17px;
    padding: 0 5px;
  }

  .music-length input[type=range] {
    -webkit-appearance: none;

    // 这个属性设置使填充进度条时的图形为圆角
  }

  .voice-range input {
    width: 50px;
    height: 20px;

    &[type=range]::-webkit-slider-runnable-track {
      height: 5px;
      background: #0d1112;
      // box-shadow: 0 1px 1px #def3f8, inset 0 .125em .125em #0d1112; // 轨道内置阴影效果
    }

    &[type=range]::-webkit-slider-thumb {
      margin-top: -8px;
    }
  }

  .music-length input {
    width: 100%;
    height: 2px;
    margin-top: 10px;
    background: transparent;

    &[type=range]::-webkit-slider-runnable-track {
      height: 2px;
      margin-top: -7px;
      background: #0d1112;
      // box-shadow: 0 1px 1px #def3f8, inset 0 .125em .125em #0d1112; // 轨道内置阴影效果
    }

    &[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 10px;
      width: 10px;
      margin-top: -5px;

      // 使滑块超出轨道部分的偏移量相等
      background: #fff;
      border-radius: 50%;

      // 外观设置为圆形
      border: solid 0.125em rgba(205, 224, 230, 0.5);

      // 设置边框
      box-shadow: 0 0.125em 0.125em #3b4547;

      // 添加底部阴影
    }

    &[type=range]:focus {
      outline: none;
    }
  }

  .music-duration {
    padding: 0 10px;
  }

  .music-voice {
    cursor: pointer;
    position: relative;
    width: 11px;
  }

  .voice-range {
    transform: rotateZ(-90deg) translate3d(45px, -6px, 0);
    position: absolute;
    top: -4.5px;
    right: -38px;
    padding: 4px 10px;
    cursor: auto;
    z-index: 1000;
    font-size: 0;
    background: #eee;
  }

  .down-load-file {
    margin-left: 10px;

    .ivu-icon {
      color: #495060;
    }
  }
}
</style>
